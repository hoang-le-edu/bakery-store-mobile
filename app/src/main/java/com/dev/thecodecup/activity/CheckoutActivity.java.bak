package com.dev.thecodecup.activity;

import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.RadioGroup;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;

import com.dev.thecodecup.model.network.NetworkModule;
import com.dev.thecodecup.model.network.api.BakeryApiService;
import com.dev.thecodecup.model.network.api.ProceedOrderRequest;
import com.dev.thecodecup.R;
import com.google.android.material.button.MaterialButton;
import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.google.firebase.auth.FirebaseAuth;

import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

public class CheckoutActivity extends AppCompatActivity {

    private BakeryApiService apiService;
    private Long cartId;
    private double totalPrice;

    // Address fields
    private Spinner spinnerProvince, spinnerDistrict, spinnerWard;
    private EditText edtStreetAddress, edtReceiverName, edtReceiverPhone;
    
    // Payment
    private RadioGroup radioGroupPayment;
    
    // Order summary
    private TextView txtOrderTotal, txtShippingFee, txtFinalTotal;
    private MaterialButton btnPlaceOrder;

    // Address data
    private Map<String, List<String>> provinceDistrictMap = new HashMap<>();
    private Map<String, List<String>> districtWardMap = new HashMap<>();

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_checkout);

        apiService = NetworkModule.INSTANCE.provideBakeryApiService();

        // Get cart data from intent
        cartId = getIntent().getLongExtra("CART_ID", -1);
        totalPrice = getIntent().getDoubleExtra("TOTAL_PRICE", 0.0);

        if (cartId == -1) {
            Toast.makeText(this, "Lỗi: Không tìm thấy giỏ hàng", Toast.LENGTH_SHORT).show();
            finish();
            return;
        }

        initViews();
        setupToolbar();
        initAddressData();
        setupSpinners();
        displayOrderSummary();
        setupListeners();
    }

    private void initViews() {
        spinnerProvince = findViewById(R.id.spinnerProvince);
        spinnerDistrict = findViewById(R.id.spinnerDistrict);
        spinnerWard = findViewById(R.id.spinnerWard);
        edtStreetAddress = findViewById(R.id.edtStreetAddress);
        edtReceiverName = findViewById(R.id.edtReceiverName);
        edtReceiverPhone = findViewById(R.id.edtReceiverPhone);
        radioGroupPayment = findViewById(R.id.radioGroupPayment);
        txtOrderTotal = findViewById(R.id.txtOrderTotal);
        txtShippingFee = findViewById(R.id.txtShippingFee);
        txtFinalTotal = findViewById(R.id.txtFinalTotal);
        btnPlaceOrder = findViewById(R.id.btnPlaceOrder);
    }

    private void setupToolbar() {
        Toolbar toolbar = findViewById(R.id.toolbar);
        setSupportActionBar(toolbar);
        if (getSupportActionBar() != null) {
            getSupportActionBar().setDisplayHomeAsUpEnabled(true);
        }
        toolbar.setNavigationOnClickListener(v -> onBackPressed());
    }

    private void initAddressData() {
        // Sample Vietnam address data (simplified)
        List<String> hanoiDistricts = List.of("Hoàn Kiếm", "Ba Đình", "Đống Đa", "Hai Bà Trưng", "Cầu Giấy", "Thanh Xuân");
        List<String> hcmDistricts = List.of("Quận 1", "Quận 2", "Quận 3", "Quận 4", "Quận 5", "Quận 10", "Thủ Đức");
        List<String> dnDistricts = List.of("Hải Châu", "Thanh Khê", "Sơn Trà", "Ngũ Hành Sơn", "Liên Chiểu");

        provinceDistrictMap.put("Hà Nội", hanoiDistricts);
        provinceDistrictMap.put("Hồ Chí Minh", hcmDistricts);
        provinceDistrictMap.put("Đà Nẵng", dnDistricts);

        // Sample wards (phường/xã)
        List<String> sampleWards = List.of("Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5");
        for (String province : provinceDistrictMap.keySet()) {
            for (String district : provinceDistrictMap.get(province)) {
                districtWardMap.put(district, new ArrayList<>(sampleWards));
            }
        }
    }

    private void setupSpinners() {
        // Province spinner
        List<String> provinces = new ArrayList<>(provinceDistrictMap.keySet());
        ArrayAdapter<String> provinceAdapter = new ArrayAdapter<>(this,
                android.R.layout.simple_spinner_dropdown_item, provinces);
        spinnerProvince.setAdapter(provinceAdapter);

        spinnerProvince.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                String selectedProvince = provinces.get(position);
                List<String> districts = provinceDistrictMap.get(selectedProvince);
                ArrayAdapter<String> districtAdapter = new ArrayAdapter<>(CheckoutActivity.this,
                        android.R.layout.simple_spinner_dropdown_item, districts);
                spinnerDistrict.setAdapter(districtAdapter);
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {}
        });

        spinnerDistrict.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                String selectedDistrict = (String) spinnerDistrict.getSelectedItem();
                List<String> wards = districtWardMap.get(selectedDistrict);
                if (wards != null) {
                    ArrayAdapter<String> wardAdapter = new ArrayAdapter<>(CheckoutActivity.this,
                            android.R.layout.simple_spinner_dropdown_item, wards);
                    spinnerWard.setAdapter(wardAdapter);
                }
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {}
        });
    }

    private void displayOrderSummary() {
        NumberFormat formatter = NumberFormat.getCurrencyInstance(new Locale("vi", "VN"));
        
        txtOrderTotal.setText(formatter.format(totalPrice));
        
        double shippingFee = 30000; // Fixed shipping fee
        txtShippingFee.setText(formatter.format(shippingFee));
        
        double finalTotal = totalPrice + shippingFee;
        txtFinalTotal.setText(formatter.format(finalTotal));
    }

    private void setupListeners() {
        btnPlaceOrder.setOnClickListener(v -> validateAndPlaceOrder());
    }

    private void validateAndPlaceOrder() {
        String receiverName = edtReceiverName.getText().toString().trim();
        String receiverPhone = edtReceiverPhone.getText().toString().trim();
        String streetAddress = edtStreetAddress.getText().toString().trim();
        String province = (String) spinnerProvince.getSelectedItem();
        String district = (String) spinnerDistrict.getSelectedItem();
        String ward = (String) spinnerWard.getSelectedItem();

        if (receiverName.isEmpty()) {
            edtReceiverName.setError("Vui lòng nhập tên người nhận");
            edtReceiverName.requestFocus();
            return;
        }

        if (receiverPhone.isEmpty() || receiverPhone.length() < 10) {
            edtReceiverPhone.setError("Số điện thoại không hợp lệ");
            edtReceiverPhone.requestFocus();
            return;
        }

        if (streetAddress.isEmpty()) {
            edtStreetAddress.setError("Vui lòng nhập địa chỉ");
            edtStreetAddress.requestFocus();
            return;
        }

        int selectedPaymentId = radioGroupPayment.getCheckedRadioButtonId();
        if (selectedPaymentId == -1) {
            Toast.makeText(this, "Vui lòng chọn phương thức thanh toán", Toast.LENGTH_SHORT).show();
            return;
        }

        String paymentMethod = selectedPaymentId == R.id.radioCOD ? "COD" : "Online";

        // Build full address
        String fullAddress = streetAddress + ", " + ward + ", " + district + ", " + province;

        // Show confirmation dialog
        showConfirmationDialog(receiverName, receiverPhone, fullAddress, paymentMethod);
    }

    private void showConfirmationDialog(String receiverName, String receiverPhone, 
                                       String address, String paymentMethod) {
        new MaterialAlertDialogBuilder(this)
                .setTitle("Xác nhận đặt hàng")
                .setMessage("Người nhận: " + receiverName + "\n" +
                           "SĐT: " + receiverPhone + "\n" +
                           "Địa chỉ: " + address + "\n" +
                           "Thanh toán: " + paymentMethod)
                .setPositiveButton("Đặt hàng", (dialog, which) -> 
                    placeOrder(receiverName, receiverPhone, address, paymentMethod))
                .setNegativeButton("Hủy", null)
                .show();
    }

    private void placeOrder(String receiverName, String receiverPhone, 
                           String address, String paymentMethod) {
        btnPlaceOrder.setEnabled(false);
        btnPlaceOrder.setText("Đang xử lý...");

        String userEmail = FirebaseAuth.getInstance().getCurrentUser().getEmail();

        ProceedOrderRequest request = new ProceedOrderRequest(
                cartId,
                userEmail,
                receiverName,
                receiverPhone,
                address,
                paymentMethod
        );

        apiService.proceedOrder(request).enqueue(new Callback<Void>() {
            @Override
            public void onResponse(Call<Void> call, Response<Void> response) {
                btnPlaceOrder.setEnabled(true);
                btnPlaceOrder.setText("Đặt hàng");

                if (response.isSuccessful()) {
                    showSuccessDialog();
                } else {
                    Toast.makeText(CheckoutActivity.this, 
                            "Đặt hàng thất bại: " + response.message(), 
                            Toast.LENGTH_SHORT).show();
                }
            }

            @Override
            public void onFailure(Call<Void> call, Throwable t) {
                btnPlaceOrder.setEnabled(true);
                btnPlaceOrder.setText("Đặt hàng");
                Toast.makeText(CheckoutActivity.this, 
                        "Lỗi kết nối: " + t.getMessage(), 
                        Toast.LENGTH_SHORT).show();
            }
        });
    }

    private void showSuccessDialog() {
        new MaterialAlertDialogBuilder(this)
                .setTitle("Đặt hàng thành công!")
                .setMessage("Đơn hàng của bạn đã được ghi nhận. Vui lòng chờ xác nhận từ cửa hàng.")
                .setPositiveButton("Xem đơn hàng", (dialog, which) -> {
                    Intent intent = new Intent(CheckoutActivity.this, OrdersActivity.class);
                    intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
                    startActivity(intent);
                    finish();
                })
                .setCancelable(false)
                .show();
    }
}
